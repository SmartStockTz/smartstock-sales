import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { EventService } from './event.service';
import { BFast } from 'bfastjs';
import { SecurityUtil } from '../utils/security.util';
import { SsmEvents } from '../utils/eventsNames.util';
import * as i0 from "@angular/core";
import * as i1 from "./event.service";
export class StorageService {
    constructor(eventApi) {
        this.eventApi = eventApi;
        this.smartStockCache = BFast.cache({ database: 'smartstock', collection: 'config' });
    }
    getActiveUser() {
        return __awaiter(this, void 0, void 0, function* () {
            return yield BFast.auth().currentUser();
        });
    }
    saveSales(batchs) {
        return __awaiter(this, void 0, void 0, function* () {
            const activeShop = yield this.getActiveShop();
            yield BFast.cache({ database: 'sales', collection: activeShop.projectId })
                .set(SecurityUtil.randomString(12), batchs, {
                dtl: 720
            });
        });
    }
    getActiveShop() {
        return __awaiter(this, void 0, void 0, function* () {
            const response = yield this.smartStockCache.get('activeShop');
            if (response) {
                return response;
            }
            else {
                throw { message: 'No Active Shop' };
            }
        });
    }
    saveActiveShop(shop) {
        return __awaiter(this, void 0, void 0, function* () {
            const response = yield this.smartStockCache.set('activeShop', shop, {
                dtl: 7
            });
            this.eventApi.broadcast(SsmEvents.ACTIVE_SHOP_SET);
            return response;
        });
    }
    getCurrentProjectId() {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.smartStockCache.get('cPID');
        });
    }
    saveCurrentProjectId(projectId) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.smartStockCache.set('cPID', projectId, {
                dtl: 7
            });
        });
    }
    clearSmartStockCache() {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.smartStockCache.clearAll();
        });
    }
    saveActiveUser(user) {
        return __awaiter(this, void 0, void 0, function* () {
            return BFast.auth().setCurrentUser(user, 6);
        });
    }
    removeActiveShop() {
        return __awaiter(this, void 0, void 0, function* () {
            const response = yield this.smartStockCache.set('activeShop', undefined);
            this.eventApi.broadcast(SsmEvents.ACTIVE_SHOP_REMOVE);
            return response;
        });
    }
    removeActiveUser() {
        return __awaiter(this, void 0, void 0, function* () {
            return yield BFast.auth().setCurrentUser(undefined, 0);
        });
    }
    removeStocks() {
        return __awaiter(this, void 0, void 0, function* () {
            const shop = yield this.getActiveShop();
            return yield BFast.cache({ database: 'stocks', collection: shop.projectId }).clearAll();
        });
    }
    getStocks() {
        return __awaiter(this, void 0, void 0, function* () {
            const shop = yield this.getActiveShop();
            const stocksCache = BFast.cache({ database: 'stocks', collection: shop.projectId });
            return yield stocksCache.get('all');
        });
    }
    saveStocks(stocks) {
        return __awaiter(this, void 0, void 0, function* () {
            const shop = yield this.getActiveShop();
            const stocksCache = BFast.cache({ database: 'stocks', collection: shop.projectId });
            return yield stocksCache.set('all', stocks, {
                dtl: 360
            });
        });
    }
    saveStock(stock) {
        return __awaiter(this, void 0, void 0, function* () {
            // const shop = await this.getActiveShop();
            // const stocksCache = BFast.cache({database: 'stocks', collection: shop.projectId});
            // return stocksCache.set(stock.id, stock);
            return undefined;
        });
    }
    getCustomers() {
        return __awaiter(this, void 0, void 0, function* () {
            const shop = yield this.getActiveShop();
            const customersCache = BFast.cache({ database: 'customers', collection: shop.projectId });
            const customersKey = yield customersCache.keys();
            const customers = [];
            for (const key of customersKey) {
                customers.push(yield customersCache.get(key));
            }
            return customers;
        });
    }
    saveCustomer(customer) {
        return __awaiter(this, void 0, void 0, function* () {
            const shop = yield this.getActiveShop();
            const customersCache = BFast.cache({ database: 'customers', collection: shop.projectId });
            return yield customersCache.set(customer.displayName, customer, {
                dtl: 360
            });
        });
    }
}
StorageService.ɵprov = i0.ɵɵdefineInjectable({ factory: function StorageService_Factory() { return new StorageService(i0.ɵɵinject(i1.EventService)); }, token: StorageService, providedIn: "root" });
StorageService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
StorageService.ctorParameters = () => [
    { type: EventService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy93YXBwaS9XZWJTdG9ybVByb2plY3RzL3NtYXJ0c3RvY2stY29yZS1saWJzL3Byb2plY3RzL2xpYnMvc3JjLyIsInNvdXJjZXMiOlsic2VydmljZXMvc3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUNwRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7OztBQVlwRCxNQUFNLE9BQU8sY0FBYztJQUd6QixZQUE2QixRQUFzQjtRQUF0QixhQUFRLEdBQVIsUUFBUSxDQUFjO1FBRm5ELG9CQUFlLEdBQW9CLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDO0lBRy9GLENBQUM7SUFFSyxhQUFhOztZQUNqQixPQUFPLE1BQU0sS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzFDLENBQUM7S0FBQTtJQUVLLFNBQVMsQ0FBQyxNQUFvQjs7WUFDbEMsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDOUMsTUFBTSxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLFNBQVMsRUFBQyxDQUFDO2lCQUNyRSxHQUFHLENBQWUsWUFBWSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUU7Z0JBQ3hELEdBQUcsRUFBRSxH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QTdHRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWRPLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtFdmVudFNlcnZpY2V9IGZyb20gJy4vZXZlbnQuc2VydmljZSc7XG5pbXBvcnQge0JGYXN0fSBmcm9tICdiZmFzdGpzJztcbmltcG9ydCB7U2VjdXJpdHlVdGlsfSBmcm9tICcuLi91dGlscy9zZWN1cml0eS51dGlsJztcbmltcG9ydCB7U3NtRXZlbnRzfSBmcm9tICcuLi91dGlscy9ldmVudHNOYW1lcy51dGlsJztcbmltcG9ydCB7Q2FjaGVDb250cm9sbGVyfSBmcm9tICdiZmFzdGpzL2Rpc3QvY29udHJvbGxlcnMvQ2FjaGVDb250cm9sbGVyJztcbmltcG9ydCB7VXNlck1vZGVsfSBmcm9tICcuLi9tb2RlbHMvdXNlci5tb2RlbCc7XG5pbXBvcnQge1Nob3BNb2RlbH0gZnJvbSAnLi4vbW9kZWxzL3Nob3AubW9kZWwnO1xuaW1wb3J0IHtDdXN0b21lck1vZGVsfSBmcm9tICcuLi9tb2RlbHMvY3VzdG9tZXIubW9kZWwnO1xuaW1wb3J0IHtTdG9ja01vZGVsfSBmcm9tICcuLi9tb2RlbHMvc3RvY2subW9kZWwnO1xuaW1wb3J0IHtCYXRjaE1vZGVsfSBmcm9tICcuLi9tb2RlbHMvYmF0Y2gubW9kZWwnO1xuXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFN0b3JhZ2VTZXJ2aWNlIHtcbiAgc21hcnRTdG9ja0NhY2hlOiBDYWNoZUNvbnRyb2xsZXIgPSBCRmFzdC5jYWNoZSh7ZGF0YWJhc2U6ICdzbWFydHN0b2NrJywgY29sbGVjdGlvbjogJ2NvbmZpZyd9KTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGV2ZW50QXBpOiBFdmVudFNlcnZpY2UpIHtcbiAgfVxuXG4gIGFzeW5jIGdldEFjdGl2ZVVzZXIoKTogUHJvbWlzZTxVc2VyTW9kZWw+IHtcbiAgICByZXR1cm4gYXdhaXQgQkZhc3QuYXV0aCgpLmN1cnJlbnRVc2VyKCk7XG4gIH1cblxuICBhc3luYyBzYXZlU2FsZXMoYmF0Y2hzOiBCYXRjaE1vZGVsW10pOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGFjdGl2ZVNob3AgPSBhd2FpdCB0aGlzLmdldEFjdGl2ZVNob3AoKTtcbiAgICBhd2FpdCBCRmFzdC5jYWNoZSh7ZGF0YWJhc2U6ICdzYWxlcycsIGNvbGxlY3Rpb246IGFjdGl2ZVNob3AucHJvamVjdElkfSlcbiAgICAgIC5zZXQ8QmF0Y2hNb2RlbFtdPihTZWN1cml0eVV0aWwucmFuZG9tU3RyaW5nKDEyKSwgYmF0Y2hzLCB7XG4gICAgICAgIGR0bDogNzIwXG4gICAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldEFjdGl2ZVNob3AoKTogUHJvbWlzZTxTaG9wTW9kZWw+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc21hcnRTdG9ja0NhY2hlLmdldDxTaG9wTW9kZWw+KCdhY3RpdmVTaG9wJyk7XG4gICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IHttZXNzYWdlOiAnTm8gQWN0aXZlIFNob3AnfTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzYXZlQWN0aXZlU2hvcChzaG9wOiBTaG9wTW9kZWwpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zbWFydFN0b2NrQ2FjaGUuc2V0PFNob3BNb2RlbD4oJ2FjdGl2ZVNob3AnLCBzaG9wLCB7XG4gICAgICBkdGw6IDdcbiAgICB9KTtcbiAgICB0aGlzLmV2ZW50QXBpLmJyb2FkY2FzdChTc21FdmVudHMuQUNUSVZFX1NIT1BfU0VUKTtcbiAgICByZXR1cm4gcmVzcG9uc2U7XG4gIH1cblxuICBhc3luYyBnZXRDdXJyZW50UHJvamVjdElkKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc21hcnRTdG9ja0NhY2hlLmdldDxzdHJpbmc+KCdjUElEJyk7XG4gIH1cblxuICBhc3luYyBzYXZlQ3VycmVudFByb2plY3RJZChwcm9qZWN0SWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc21hcnRTdG9ja0NhY2hlLnNldDxzdHJpbmc+KCdjUElEJywgcHJvamVjdElkLCB7XG4gICAgICBkdGw6IDdcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNsZWFyU21hcnRTdG9ja0NhY2hlKCk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc21hcnRTdG9ja0NhY2hlLmNsZWFyQWxsKCk7XG4gIH1cblxuICBhc3luYyBzYXZlQWN0aXZlVXNlcih1c2VyOiBVc2VyTW9kZWwpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBCRmFzdC5hdXRoKCkuc2V0Q3VycmVudFVzZXIodXNlciwgNik7XG4gIH1cblxuICBhc3luYyByZW1vdmVBY3RpdmVTaG9wKCk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNtYXJ0U3RvY2tDYWNoZS5zZXQoJ2FjdGl2ZVNob3AnLCB1bmRlZmluZWQpO1xuICAgIHRoaXMuZXZlbnRBcGkuYnJvYWRjYXN0KFNzbUV2ZW50cy5BQ1RJVkVfU0hPUF9SRU1PVkUpO1xuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUFjdGl2ZVVzZXIoKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gYXdhaXQgQkZhc3QuYXV0aCgpLnNldEN1cnJlbnRVc2VyKHVuZGVmaW5lZCwgMCk7XG4gIH1cblxuICBhc3luYyByZW1vdmVTdG9ja3MoKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBzaG9wID0gYXdhaXQgdGhpcy5nZXRBY3RpdmVTaG9wKCk7XG4gICAgcmV0dXJuIGF3YWl0IEJGYXN0LmNhY2hlKHtkYXRhYmFzZTogJ3N0b2NrcycsIGNvbGxlY3Rpb246IHNob3AucHJvamVjdElkfSkuY2xlYXJBbGwoKTtcbiAgfVxuXG4gIGFzeW5jIGdldFN0b2NrcygpOiBQcm9taXNlPFN0b2NrTW9kZWxbXT4ge1xuICAgIGNvbnN0IHNob3AgPSBhd2FpdCB0aGlzLmdldEFjdGl2ZVNob3AoKTtcbiAgICBjb25zdCBzdG9ja3NDYWNoZSA9IEJGYXN0LmNhY2hlKHtkYXRhYmFzZTogJ3N0b2NrcycsIGNvbGxlY3Rpb246IHNob3AucHJvamVjdElkfSk7XG4gICAgcmV0dXJuIGF3YWl0IHN0b2Nrc0NhY2hlLmdldDxTdG9ja01vZGVsW10+KCdhbGwnKTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVTdG9ja3Moc3RvY2tzOiBTdG9ja01vZGVsW10pOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHNob3AgPSBhd2FpdCB0aGlzLmdldEFjdGl2ZVNob3AoKTtcbiAgICBjb25zdCBzdG9ja3NDYWNoZSA9IEJGYXN0LmNhY2hlKHtkYXRhYmFzZTogJ3N0b2NrcycsIGNvbGxlY3Rpb246IHNob3AucHJvamVjdElkfSk7XG4gICAgcmV0dXJuIGF3YWl0IHN0b2Nrc0NhY2hlLnNldCgnYWxsJywgc3RvY2tzLCB7XG4gICAgICBkdGw6IDM2MFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVN0b2NrKHN0b2NrOiBTdG9ja01vZGVsKTogUHJvbWlzZTxTdG9ja01vZGVsPiB7XG4gICAgLy8gY29uc3Qgc2hvcCA9IGF3YWl0IHRoaXMuZ2V0QWN0aXZlU2hvcCgpO1xuICAgIC8vIGNvbnN0IHN0b2Nrc0NhY2hlID0gQkZhc3QuY2FjaGUoe2RhdGFiYXNlOiAnc3RvY2tzJywgY29sbGVjdGlvbjogc2hvcC5wcm9qZWN0SWR9KTtcbiAgICAvLyByZXR1cm4gc3RvY2tzQ2FjaGUuc2V0KHN0b2NrLmlkLCBzdG9jayk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGFzeW5jIGdldEN1c3RvbWVycygpOiBQcm9taXNlPEN1c3RvbWVyTW9kZWxbXT4ge1xuICAgIGNvbnN0IHNob3AgPSBhd2FpdCB0aGlzLmdldEFjdGl2ZVNob3AoKTtcbiAgICBjb25zdCBjdXN0b21lcnNDYWNoZSA9IEJGYXN0LmNhY2hlKHtkYXRhYmFzZTogJ2N1c3RvbWVycycsIGNvbGxlY3Rpb246IHNob3AucHJvamVjdElkfSk7XG4gICAgY29uc3QgY3VzdG9tZXJzS2V5ID0gYXdhaXQgY3VzdG9tZXJzQ2FjaGUua2V5cygpO1xuICAgIGNvbnN0IGN1c3RvbWVycyA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIGN1c3RvbWVyc0tleSkge1xuICAgICAgY3VzdG9tZXJzLnB1c2goYXdhaXQgY3VzdG9tZXJzQ2FjaGUuZ2V0PEN1c3RvbWVyTW9kZWw+KGtleSkpO1xuICAgIH1cbiAgICByZXR1cm4gY3VzdG9tZXJzO1xuICB9XG5cbiAgYXN5bmMgc2F2ZUN1c3RvbWVyKGN1c3RvbWVyOiBDdXN0b21lck1vZGVsKTogUHJvbWlzZTxDdXN0b21lck1vZGVsPiB7XG4gICAgY29uc3Qgc2hvcCA9IGF3YWl0IHRoaXMuZ2V0QWN0aXZlU2hvcCgpO1xuICAgIGNvbnN0IGN1c3RvbWVyc0NhY2hlID0gQkZhc3QuY2FjaGUoe2RhdGFiYXNlOiAnY3VzdG9tZXJzJywgY29sbGVjdGlvbjogc2hvcC5wcm9qZWN0SWR9KTtcbiAgICByZXR1cm4gYXdhaXQgY3VzdG9tZXJzQ2FjaGUuc2V0PEN1c3RvbWVyTW9kZWw+KGN1c3RvbWVyLmRpc3BsYXlOYW1lLCBjdXN0b21lciwge1xuICAgICAgZHRsOiAzNjBcbiAgICB9KTtcbiAgfVxuXG59XG4iXX0=