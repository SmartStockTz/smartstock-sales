import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { StorageService } from './storage.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./storage.service";
export class SettingsService {
    constructor(httpClient, storageService, indexDb) {
        this.httpClient = httpClient;
        this.storageService = storageService;
        this.indexDb = indexDb;
        this.ssmServerURL = 'https://smartstock-daas.bfast.fahamutech.com'; // environment.smartstock.databaseURL;
        this.ssmFunctionsURL = 'https://smartstock-faas.bfast.fahamutech.com'; // environment.smartstock.functionsURL;
        this.ssmHeader = {
            'X-Parse-Application-Id': 'smartstock'
        };
        this.ssmFunctionsHeader = {
            'bfast-application-id': 'smartstock',
            'content-type': 'application/json'
        };
    }
    getSSMUserHeader() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const user = yield this.storageService.getActiveUser();
                const activeShop = yield this.storageService.getActiveShop();
                if (!user) {
                    // console.log('no user records found');
                    throw new Error('no user records found');
                }
                if (user && user.sessionToken && activeShop && activeShop.applicationId) {
                    return {
                        'X-Parse-Application-Id': 'smartstock',
                        'X-Parse-Session-Token': user.sessionToken,
                        'Content-Type': 'application/json'
                    };
                }
                else {
                    throw new Error('token not found');
                }
            }
            catch (e) {
                throw { message: 'Fails to get user, so to retrieve token' };
            }
        });
    }
    getCustomerApplicationId() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const activeShop = yield this.storageService.getActiveShop();
                if (!activeShop) {
                    throw new Error('No user record');
                }
                return activeShop.applicationId;
            }
            catch (e) {
                throw { message: 'Fails to get application id', reason: e.toString() };
            }
        });
    }
    getCustomerServerURLId() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const activeShop = yield this.storageService.getActiveShop();
                if (!activeShop) {
                    throw new Error('No user in local storage');
                }
                return activeShop.projectUrlId;
            }
            catch (reason) {
                throw { message: 'Fails to get user', reason: reason.toString() };
            }
        });
    }
    getCustomerHeader() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                return {
                    'X-Parse-Application-Id': yield this.getCustomerApplicationId()
                };
            }
            catch (e) {
                console.warn(e);
                return {};
            }
        });
    }
    getCustomerPostHeader(contentType) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                return {
                    'X-Parse-Application-Id': yield this.getCustomerApplicationId(),
                    'content-type': contentType ? contentType : 'application/json'
                };
            }
            catch (e) {
                throw { message: 'Fails to get customer post header', reason: e.toString() };
            }
        });
    }
    getCustomerServerURL() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                return `https://${yield this.getCustomerServerURLId()}.bfast.fahamutech.com`;
            }
            catch (e) {
                throw { message: 'Fails to get server url', reason: e.toString() };
            }
        });
    }
    getCustomerProjectId() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const activeShop = yield this.indexDb.getActiveShop();
                if (!activeShop) {
                    throw new Error('No user in local storage');
                }
                return activeShop.projectId;
            }
            catch (e) {
                throw { message: 'Fails to get project id', reason: e.toString() };
            }
        });
    }
    /**
     * @deprecated
     */
    getPrinterAddress(callback) {
        // this.indexDb.getItem<{ ip: string, name: string }>('printerAddress').then(value => {
        //   callback(null);
        // }).catch(reason => {
        //   console.log(reason);
        //   callback(null);
        // });
        callback(null);
    }
    saveSettings(settings) {
        return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {
            try {
                const activeShop = yield this.storageService.getActiveShop();
                this.httpClient.put(this.ssmFunctionsURL + '/settings/' + activeShop.projectId, settings, {
                    headers: this.ssmFunctionsHeader
                }).subscribe(_ => {
                    activeShop.settings = _.settings;
                    this.storageService.saveActiveShop(activeShop).then(_1 => {
                        resolve('Shop settings updated');
                    }).catch(reason => {
                        reject(reason);
                    });
                }, error => {
                    reject(error);
                });
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    getSettings() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const activeShop = yield this.storageService.getActiveShop();
                if (!activeShop || !activeShop.settings) {
                    return {
                        printerFooter: 'Thank you',
                        printerHeader: '',
                        saleWithoutPrinter: true,
                        allowRetail: true,
                        allowWholesale: true,
                    };
                }
                return activeShop.settings;
            }
            catch (e) {
                throw { message: 'Fails to get settings', reason: e.toString() };
            }
        });
    }
}
SettingsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SettingsService_Factory() { return new SettingsService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.StorageService), i0.ɵɵinject(i2.StorageService)); }, token: SettingsService, providedIn: "root" });
SettingsService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
SettingsService.ctorParameters = () => [
    { type: HttpClient },
    { type: StorageService },
    { type: StorageService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvd2FwcGkvV2ViU3Rvcm1Qcm9qZWN0cy9zbWFydHN0b2NrLWNvcmUtbGlicy9wcm9qZWN0cy9saWJzL3NyYy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL3NldHRpbmdzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQzs7OztBQUtqRCxNQUFNLE9BQU8sZUFBZTtJQVkxQixZQUE2QixVQUFzQixFQUN0QixjQUE4QixFQUM5QixPQUF1QjtRQUZ2QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQVpwRCxpQkFBWSxHQUFHLDhDQUE4QyxDQUFDLENBQUMsc0NBQXNDO1FBQ3JHLG9CQUFlLEdBQUcsOENBQThDLENBQUMsQ0FBQyx1Q0FBdUM7UUFDekcsY0FBUyxHQUFHO1lBQ1Ysd0JBQXdCLEVBQUUsWUFBWTtTQUN2QyxDQUFDO1FBQ0YsdUJBQWtCLEdBQUc7WUFDbkIsc0JBQXNCLEVBQUUsWUFBWTtZQUNwQyxjQUFjLEVBQUUsa0JBQWtCO1NBQ25DLENBQUM7SUFLRixDQUFDO0lBRUssZ0JBQWdCOztZQUNwQixJQUFJO2dCQUNGLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDdkQsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUM3RCxJQUFJLENBQUMsSUFBSSxFQUFFO29CQUNULHdDQUF3QztvQkFDeEMsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFB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QUFDO29CQUNqQixDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDLEVBQUUsS0FBSyxDQUFDLEVBQUU7b0JBQ1QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNoQixDQUFDLENBQUMsQ0FBQzthQUNKO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVLLFdBQVc7O1lBSWYsSUFBSTtnQkFDRixNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQzdELElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFO29CQUN2QyxPQUFPO3dCQUNMLGFBQWEsRUFBRSxXQUFXO3dCQUMxQixhQUFhLEVBQUUsRUFBRTt3QkFDakIsa0JBQWtCLEVBQUUsSUFBSTt3QkFDeEIsV0FBVyxFQUFFLElBQUk7d0JBQ2pCLGNBQWMsRUFBRSxJQUFJO3FCQUNyQixDQUFDO2lCQUNIO2dCQUNELE9BQU8sVUFBVSxDQUFDLFFBQVEsQ0FBQzthQUM1QjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE1BQU0sRUFBQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBQyxDQUFDO2FBQ2hFO1FBQ0gsQ0FBQztLQUFBOzs7O1lBbEtGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBTE8sVUFBVTtZQUNWLGNBQWM7WUFBZCxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtTdG9yYWdlU2VydmljZX0gZnJvbSAnLi9zdG9yYWdlLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBTZXR0aW5nc1NlcnZpY2Uge1xuXG4gIHNzbVNlcnZlclVSTCA9ICdodHRwczovL3NtYXJ0c3RvY2stZGFhcy5iZmFzdC5mYWhhbXV0ZWNoLmNvbSc7IC8vIGVudmlyb25tZW50LnNtYXJ0c3RvY2suZGF0YWJhc2VVUkw7XG4gIHNzbUZ1bmN0aW9uc1VSTCA9ICdodHRwczovL3NtYXJ0c3RvY2stZmFhcy5iZmFzdC5mYWhhbXV0ZWNoLmNvbSc7IC8vIGVudmlyb25tZW50LnNtYXJ0c3RvY2suZnVuY3Rpb25zVVJMO1xuICBzc21IZWFkZXIgPSB7XG4gICAgJ1gtUGFyc2UtQXBwbGljYXRpb24tSWQnOiAnc21hcnRzdG9jaydcbiAgfTtcbiAgc3NtRnVuY3Rpb25zSGVhZGVyID0ge1xuICAgICdiZmFzdC1hcHBsaWNhdGlvbi1pZCc6ICdzbWFydHN0b2NrJyxcbiAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gIH07XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgICAgICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VTZXJ2aWNlOiBTdG9yYWdlU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSByZWFkb25seSBpbmRleERiOiBTdG9yYWdlU2VydmljZSkge1xuICB9XG5cbiAgYXN5bmMgZ2V0U1NNVXNlckhlYWRlcigpOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5zdG9yYWdlU2VydmljZS5nZXRBY3RpdmVVc2VyKCk7XG4gICAgICBjb25zdCBhY3RpdmVTaG9wID0gYXdhaXQgdGhpcy5zdG9yYWdlU2VydmljZS5nZXRBY3RpdmVTaG9wKCk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ25vIHVzZXIgcmVjb3JkcyBmb3VuZCcpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIHVzZXIgcmVjb3JkcyBmb3VuZCcpO1xuICAgICAgfVxuICAgICAgaWYgKHVzZXIgJiYgdXNlci5zZXNzaW9uVG9rZW4gJiYgYWN0aXZlU2hvcCAmJiBhY3RpdmVTaG9wLmFwcGxpY2F0aW9uSWQpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAnWC1QYXJzZS1BcHBsaWNhdGlvbi1JZCc6ICdzbWFydHN0b2NrJyxcbiAgICAgICAgICAnWC1QYXJzZS1TZXNzaW9uLVRva2VuJzogdXNlci5zZXNzaW9uVG9rZW4sXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0b2tlbiBub3QgZm91bmQnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyB7bWVzc2FnZTogJ0ZhaWxzIHRvIGdldCB1c2VyLCBzbyB0byByZXRyaWV2ZSB0b2tlbid9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEN1c3RvbWVyQXBwbGljYXRpb25JZCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYWN0aXZlU2hvcCA9IGF3YWl0IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0QWN0aXZlU2hvcCgpO1xuICAgICAgaWYgKCFhY3RpdmVTaG9wKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXNlciByZWNvcmQnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY3RpdmVTaG9wLmFwcGxpY2F0aW9uSWQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cge21lc3NhZ2U6ICdGYWlscyB0byBnZXQgYXBwbGljYXRpb24gaWQnLCByZWFzb246IGUudG9TdHJpbmcoKX07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0Q3VzdG9tZXJTZXJ2ZXJVUkxJZCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYWN0aXZlU2hvcCA9IGF3YWl0IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0QWN0aXZlU2hvcCgpO1xuICAgICAgaWYgKCFhY3RpdmVTaG9wKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXNlciBpbiBsb2NhbCBzdG9yYWdlJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gYWN0aXZlU2hvcC5wcm9qZWN0VXJsSWQ7XG4gICAgfSBjYXRjaCAocmVhc29uKSB7XG4gICAgICB0aHJvdyB7bWVzc2FnZTogJ0ZhaWxzIHRvIGdldCB1c2VyJywgcmVhc29uOiByZWFzb24udG9TdHJpbmcoKX07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0Q3VzdG9tZXJIZWFkZXIoKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgJ1gtUGFyc2UtQXBwbGljYXRpb24tSWQnOiBhd2FpdCB0aGlzLmdldEN1c3RvbWVyQXBwbGljYXRpb25JZCgpXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUud2FybihlKTtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRDdXN0b21lclBvc3RIZWFkZXIoY29udGVudFR5cGU/OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAnWC1QYXJzZS1BcHBsaWNhdGlvbi1JZCc6IGF3YWl0IHRoaXMuZ2V0Q3VzdG9tZXJBcHBsaWNhdGlvbklkKCksXG4gICAgICAgICdjb250ZW50LXR5cGUnOiBjb250ZW50VHlwZSA/IGNvbnRlbnRUeXBlIDogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IHttZXNzYWdlOiAnRmFpbHMgdG8gZ2V0IGN1c3RvbWVyIHBvc3QgaGVhZGVyJywgcmVhc29uOiBlLnRvU3RyaW5nKCl9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEN1c3RvbWVyU2VydmVyVVJMKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2F3YWl0IHRoaXMuZ2V0Q3VzdG9tZXJTZXJ2ZXJVUkxJZCgpfS5iZmFzdC5mYWhhbXV0ZWNoLmNvbWA7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cge21lc3NhZ2U6ICdGYWlscyB0byBnZXQgc2VydmVyIHVybCcsIHJlYXNvbjogZS50b1N0cmluZygpfTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRDdXN0b21lclByb2plY3RJZCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhY3RpdmVTaG9wID0gYXdhaXQgdGhpcy5pbmRleERiLmdldEFjdGl2ZVNob3AoKTtcbiAgICAgIGlmICghYWN0aXZlU2hvcCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVzZXIgaW4gbG9jYWwgc3RvcmFnZScpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjdGl2ZVNob3AucHJvamVjdElkO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IHttZXNzYWdlOiAnRmFpbHMgdG8gZ2V0IHByb2plY3QgaWQnLCByZWFzb246IGUudG9TdHJpbmcoKX07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJpbnRlckFkZHJlc3MoY2FsbGJhY2s6ICh2YWx1ZTogeyBpcDogc3RyaW5nLCBuYW1lOiBzdHJpbmcgfSkgPT4gdm9pZCkge1xuICAgIC8vIHRoaXMuaW5kZXhEYi5nZXRJdGVtPHsgaXA6IHN0cmluZywgbmFtZTogc3RyaW5nIH0+KCdwcmludGVyQWRkcmVzcycpLnRoZW4odmFsdWUgPT4ge1xuICAgIC8vICAgY2FsbGJhY2sobnVsbCk7XG4gICAgLy8gfSkuY2F0Y2gocmVhc29uID0+IHtcbiAgICAvLyAgIGNvbnNvbGUubG9nKHJlYXNvbik7XG4gICAgLy8gICBjYWxsYmFjayhudWxsKTtcbiAgICAvLyB9KTtcbiAgICBjYWxsYmFjayhudWxsKTtcbiAgfVxuXG4gIHNhdmVTZXR0aW5ncyhzZXR0aW5nczogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55Pihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBhY3RpdmVTaG9wID0gYXdhaXQgdGhpcy5zdG9yYWdlU2VydmljZS5nZXRBY3RpdmVTaG9wKCk7XG4gICAgICAgIHRoaXMuaHR0cENsaWVudC5wdXQ8YW55Pih0aGlzLnNzbUZ1bmN0aW9uc1VSTCArICcvc2V0dGluZ3MvJyArIGFjdGl2ZVNob3AucHJvamVjdElkLCBzZXR0aW5ncywge1xuICAgICAgICAgIGhlYWRlcnM6IHRoaXMuc3NtRnVuY3Rpb25zSGVhZGVyXG4gICAgICAgIH0pLnN1YnNjcmliZShfID0+IHtcbiAgICAgICAgICBhY3RpdmVTaG9wLnNldHRpbmdzID0gXy5zZXR0aW5ncztcbiAgICAgICAgICB0aGlzLnN0b3JhZ2VTZXJ2aWNlLnNhdmVBY3RpdmVTaG9wKGFjdGl2ZVNob3ApLnRoZW4oXzEgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZSgnU2hvcCBzZXR0aW5ncyB1cGRhdGVkJyk7XG4gICAgICAgICAgfSkuY2F0Y2gocmVhc29uID0+IHtcbiAgICAgICAgICAgIHJlamVjdChyZWFzb24pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJlamVjdChlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFNldHRpbmdzKCk6IFByb21pc2U8e1xuICAgIHByaW50ZXJGb290ZXI6IHN0cmluZywgcHJpbnRlckhlYWRlcjogc3RyaW5nLCBzYWxlV2l0aG91dFByaW50ZXI6IGJvb2xlYW4sXG4gICAgYWxsb3dSZXRhaWw6IGJvb2xlYW4sIGFsbG93V2hvbGVzYWxlOiBib29sZWFuXG4gIH0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYWN0aXZlU2hvcCA9IGF3YWl0IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0QWN0aXZlU2hvcCgpO1xuICAgICAgaWYgKCFhY3RpdmVTaG9wIHx8ICFhY3RpdmVTaG9wLnNldHRpbmdzKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcHJpbnRlckZvb3RlcjogJ1RoYW5rIHlvdScsXG4gICAgICAgICAgcHJpbnRlckhlYWRlcjogJycsXG4gICAgICAgICAgc2FsZVdpdGhvdXRQcmludGVyOiB0cnVlLFxuICAgICAgICAgIGFsbG93UmV0YWlsOiB0cnVlLFxuICAgICAgICAgIGFsbG93V2hvbGVzYWxlOiB0cnVlLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjdGl2ZVNob3Auc2V0dGluZ3M7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cge21lc3NhZ2U6ICdGYWlscyB0byBnZXQgc2V0dGluZ3MnLCByZWFzb246IGUudG9TdHJpbmcoKX07XG4gICAgfVxuICB9XG59XG4iXX0=